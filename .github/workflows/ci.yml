name: Cypress E2E Tests

on:
  push:
    branches: main 
  pull_request:
    branches: main
  workflow_dispatch:

jobs:
  cypress-run:
    runs-on: ubuntu-22.04
    
    strategy:
      fail-fast: false
      matrix:
        browser: [chrome, firefox, edge]
        
    name: E2E Tests - ${{ matrix.browser }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install Dependencies
        run: npm ci
        
      - name: Cypress Info
        run: npx cypress info
        
      - name: Verify Cypress
        run: npx cypress verify
        
      - name: Run Cypress Tests
        uses: cypress-io/github-action@v6
        with:
          browser: ${{ matrix.browser }}
          headed: false
          record: false
          config: video=true,screenshotOnRunFailure=true
        env:
          CYPRESS_baseUrl: https://automationexercise.com
      
      - name: Merge Mochawesome Reports
        if: always()
        run: npm run cy:report:merge
        continue-on-error: true
        
      - name: Generate HTML Report
        if: always()
        run: npm run cy:report:generate
        continue-on-error: true
          
      - name: Upload Screenshots (on failure)
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-screenshots-${{ matrix.browser }}
          path: cypress/screenshots
          retention-days: 7
          
      - name: Upload Videos
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-videos-${{ matrix.browser }}
          path: cypress/videos
          retention-days: 7
          
      - name: Upload HTML Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mochawesome-report-${{ matrix.browser }}
          path: cypress/reports/html
          retention-days: 30
          
      - name: Upload JSON Reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-json-${{ matrix.browser }}
          path: cypress/reports/json
          retention-days: 30

 
  test-summary:
    runs-on: ubuntu-22.04
    needs: cypress-run
    if: always()
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: Create Test Summary
        run: |
          echo "# üß™ Test Execution Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìä Execution Details" >> $GITHUB_STEP_SUMMARY
          echo "- **Date:** $(date '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üåê Browsers Tested" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Chrome" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Firefox" >> $GITHUB_STEP_SUMMARY
          echo "- ‚úÖ Edge" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üì¶ Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "Check the artifacts section below for:" >> $GITHUB_STEP_SUMMARY
          echo "- ÔøΩ **Mochawesome HTML Reports** (interactive reports per browser)" >> $GITHUB_STEP_SUMMARY
          echo "- ÔøΩüìπ Test execution videos" >> $GITHUB_STEP_SUMMARY
          echo "- üì∏ Failure screenshots" >> $GITHUB_STEP_SUMMARY
          echo "- üìÑ JSON test results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## üìä How to View Reports" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the \`mochawesome-report-{browser}\` artifact" >> $GITHUB_STEP_SUMMARY
          echo "2. Extract the ZIP file" >> $GITHUB_STEP_SUMMARY
          echo "3. Open \`index.html\` in your browser" >> $GITHUB_STEP_SUMMARY

  notify:
    runs-on: ubuntu-22.04
    needs: cypress-run
    if: always()
    
    steps:
      - name: Check Test Status
        run: |
          if [ "${{ needs.cypress-run.result }}" == "success" ]; then
            echo "‚úÖ All tests passed successfully!"
          else
            echo "‚ùå Some tests failed. Check the artifacts for details."
            exit 1
          fi